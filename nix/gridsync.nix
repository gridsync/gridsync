{ python3Packages
, fetchFromGitHub
, gnumake
, wrapQtAppsHook
, xvfb_run
, autobahn
, humanize
, hyperlink
, magic-wormhole
, pynacl
, pyqt5
, pyqtchart
, pyyaml
, qt5reactor
, treq
, twisted
, txtorcon
, zxcvbn
, atomicwrites
, distro
, tahoe-lafs-env
, magic-folder-env

, tox
, pytest
, pytestcov
, pytesttwisted
, pytestqt
}:
python3Packages.buildPythonApplication rec {
  version = "v0.4.2.dev";
  pname = "gridsync";
  name = "${pname}-${version}";
  src = ../.;

  patches = [ ./test_network.patch ];

  nativeBuildInputs = [
    wrapQtAppsHook
  ];

  buildInputs = pythonPath;

  propagatedBuildInputs = [ tahoe-lafs-env magic-folder-env ];

  # pythonPath is deprecated but setting it is the only way to get run-time
  # dependencies injected by the wrapper generated by buildPythonApplication!
  pythonPath = [
    atomicwrites
    autobahn
    distro
    humanize
    hyperlink
    magic-wormhole
    pynacl
    pyqt5
    pyqtchart
    pyyaml
    qt5reactor
    treq
    twisted
    twisted.extras.tls
    txtorcon
    zxcvbn
  ];

  checkInputs = [
    tox
    pytest
    pytestcov
    pytesttwisted
    pytestqt
    xvfb_run
  ];

  # Wrap it ourselves because non-ELF executables are ignored by the automatic
  # wrapping logic.  Do this in postFixup so that the Nixpkgs Python support
  # can do the Python wrapping.  wrapProgram replaces the Python script with a
  # shell script which won't be recognized by wrapPythonPrograms, I suppose.
  postFixup = ''
    wrapProgram "$out/bin/gridsync" "''${qtWrapperArgs[@]}"
  '';

  # The test suite also needs Qt to work.  So wrap up the command for running
  # the test suite with the same Qt wrapper args and then run that wrapper.
  checkPhase = ''
    echo ${xvfb_run}/bin/xvfb-run -a pytest tests > run-tests.sh
    chmod u+x run-tests.sh
    wrapProgram run-tests.sh "''${qtWrapperArgs[@]}"
    ./run-tests.sh
  '';
}
